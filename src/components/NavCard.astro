---
import { navBarConfig } from "../config";
import { LinkPresets } from "../constants/link-presets";
import { type NavBarLink, LinkPreset } from "../types/config";
import { url } from "../utils/url-utils";
import { Icon } from "astro-icon/components";

let links: NavBarLink[] = navBarConfig.links.map(
	(item: NavBarLink | LinkPreset): NavBarLink => {
		if (typeof item === "number") {
			return LinkPresets[item];
		}
		return item;
	},
);
---

<div class="relative flex justify-center items-center gap-2 mx-4 mt-4 first:mt-0 px-6 py-4 nav-card">
	{links.map((l) => (
		<a
			aria-label={l.name}
			href={l.external ? l.url : url(l.url)}
			target={l.external ? "_blank" : null}
			class="px-4 py-2 rounded-lg font-bold text-90 hover:text-[var(--primary)] dark:text-white/90 active:scale-95 transition-all nav-link"
			data-link-preset={l.url}
		>
			<span class="nav-link-text">{l.name}</span>
		</a>
	))}
<!--	<button
		id="navcard-theme-switch"
		aria-label="Toggle Theme"
		class="-top-3 -right-3 absolute flex justify-center items-center bg-[var(--card-bg)] shadow-md border border-black/10 dark:border-white/20 rounded-full w-8 h-8 hover:scale-110 active:scale-95 transition-all"
	>
		<Icon id="theme-icon-light" name="material-symbols:light-mode" class="hidden text-[1.25rem] text-black/70" />
		<Icon id="theme-icon-dark" name="material-symbols:dark-mode" class="hidden text-[1.25rem] text-white/70" />
		<Icon id="theme-icon-auto-light" name="material-symbols:brightness-4" class="hidden text-[1.25rem] text-black/70" />
		<Icon id="theme-icon-auto-dark" name="material-symbols:brightness-4" class="hidden text-[1.25rem] text-white/70" />
	</button>-->
</div>

<script>
	// 防止重复执行
	if (!(window as any).__navCardInitialized) {
		(window as any).__navCardInitialized = true;

		// 主题模式枚举
		const THEME_MODES = ['light', 'dark', 'auto'] as const;
		const THEME_ICONS = {
			light: 'theme-icon-light',
			dark: 'theme-icon-dark',
			auto: ['theme-icon-auto-light', 'theme-icon-auto-dark']
		} as const;

		// 获取当前主题模式
		function getCurrentThemeMode(): typeof THEME_MODES[number] {
			const savedTheme = localStorage.theme;
			return THEME_MODES.includes(savedTheme as never) ? savedTheme : 'auto';
		}

		// 获取系统是否偏好暗色
		function isSystemDark(): boolean {
			return window.matchMedia('(prefers-color-scheme: dark)').matches;
		}

		// 应用主题
		function applyTheme(mode: typeof THEME_MODES[number]) {
			const isDark = mode === 'dark' || (mode === 'auto' && isSystemDark());
			document.documentElement.classList.toggle('dark', isDark);
		}

		// 更新按钮图标
		function updateThemeIcon(mode: typeof THEME_MODES[number]) {
			const iconIds = ['theme-icon-light', 'theme-icon-dark', 'theme-icon-auto-light', 'theme-icon-auto-dark'];
			let activeIconId: string;

			if (mode === 'auto') {
				activeIconId = isSystemDark() ? 'theme-icon-auto-dark' : 'theme-icon-auto-light';
			} else {
				activeIconId = THEME_ICONS[mode] as string;
			}

			iconIds.forEach(id => {
				document.getElementById(id)?.classList.toggle('hidden', id !== activeIconId);
			});
		}

		// 主题切换功能
		function switchTheme() {
			const currentIndex = THEME_MODES.indexOf(getCurrentThemeMode());
			const nextMode = THEME_MODES[(currentIndex + 1) % THEME_MODES.length];

			localStorage.theme = nextMode;
			applyTheme(nextMode);
			updateThemeIcon(nextMode);
		}

		// 标记当前页面的链接
		function markActiveLink() {
			const currentPath = window.location.pathname;

			document.querySelectorAll<HTMLAnchorElement>('.nav-link').forEach(link => {
				const href = link.getAttribute('href');
				const isExternal = link.target === '_blank';

				const shouldActive = !isExternal && href !== null && (
					href === currentPath ||
					(href !== '/' && (currentPath === href || currentPath.startsWith(href + '/')))
				);

				link.classList.toggle('active', shouldActive);
			});
		}

		// 监听系统主题变化
		const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
		mediaQuery.addEventListener('change', () => {
			if (getCurrentThemeMode() === 'auto') {
				applyTheme('auto');
				updateThemeIcon('auto');
			}
		});

		// Swup钩子处理
		let swupRegistered = false;
		function registerSwupHooks() {
			const swup = (window as any).swup?.hooks;
			if (swup && !swupRegistered) {
				swup.on('content:replace', () => setTimeout(markActiveLink, 50));
				swupRegistered = true;
			} else if (!swup) {
				setTimeout(registerSwupHooks, 100);
			}
		}

		// 初始化
		const init = () => {
			const currentMode = getCurrentThemeMode();
			applyTheme(currentMode);
			updateThemeIcon(currentMode);
			markActiveLink();

			document.getElementById('navcard-theme-switch')?.addEventListener('click', switchTheme);
			registerSwupHooks();
		};

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', init);
		} else {
			init();
		}
	}
</script>

<style>
	/* 大屏幕下隐藏 NavCard */
	@media (min-width: 768px) {
		.nav-card {
			display: none !important;
		}
	}

	/* 链接的下划线动画 */
	.nav-link {
		position: relative;
	}

	.nav-link::after {
		content: '';
		position: absolute;
		bottom: 2px;
		left: 0;
		right: 0;
		height: 2px;
		background: var(--primary);
		opacity: 0;
		transition: opacity 0.3s ease;
	}

	.nav-link:hover::after {
		opacity: 0.5;
	}

	/* 当前页面的链接显示下划线 */
	.nav-link.active {
		color: var(--primary);
	}

	.nav-link.active::after {
		opacity: 1;
	}
</style>




