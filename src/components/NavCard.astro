---
import { navBarConfig } from "../config";
import { LinkPresets } from "../constants/link-presets";
import { type NavBarLink, LinkPreset } from "../types/config";
import { url } from "../utils/url-utils";

let links: NavBarLink[] = navBarConfig.links.map(
	(item: NavBarLink | LinkPreset): NavBarLink => {
		if (typeof item === "number") {
			return LinkPresets[item];
		}
		return item;
	},
);
---

<div class="nav-card flex items-center gap-2 px-6 py-4 mx-4 mt-4 first:mt-0 rounded-[var(--radius-xxlarge)] bg-[var(--card-bg)]">
	{links.map((l) => (
		<a
			aria-label={l.name}
			href={l.external ? l.url : url(l.url)}
			target={l.external ? "_blank" : null}
			class="nav-link px-4 py-2 rounded-lg font-bold transition-all hover:text-[var(--primary)] active:scale-95 text-90 dark:text-white/90"
			data-link-preset={l.url}
		>
			<span class="nav-link-text">{l.name}</span>
		</a>
	))}
</div>

<script>
	// 防止重复执行
	if ((window as any).__navCardInitialized) {
	} else {
		(window as any).__navCardInitialized = true;

		// 标记当前页面的链接
		function markActiveLink() {
			const currentPath = window.location.pathname;

			const navLinks = document.querySelectorAll('.nav-link');

			navLinks.forEach((link) => {
				const href = (link as HTMLAnchorElement).getAttribute('href');
				// 移除外部链接，它们不会匹配当前路径
				const isExternal = (link as HTMLAnchorElement).target === '_blank';

				if (!isExternal && href) {
					// 精确匹配或子路径匹配
					// 例如：主页'/'应该只匹配根路径，'/archive'应该匹配'/archive'或'/archive/xxx'
					const isMatch = href === currentPath ||
						(href !== '/' && (currentPath === href || currentPath.startsWith(href + '/')));

					if (isMatch) {
						link.classList.add('active');
					} else {
						link.classList.remove('active');
					}
				} else {
					link.classList.remove('active');
				}
			});
		}

		// 页面加载时标记
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', markActiveLink);
		} else {
			markActiveLink();
		}

		// 等待Swup初始化后注册钩子
		function registerSwupHooks() {
			if (typeof window !== 'undefined' && (window as any).swup?.hooks) {
				// 移除旧的钩子（避免重复注册）
				(window as any).swup.hooks.off('content:replace', markActiveLink);
				// 注册新钩子
				(window as any).swup.hooks.on('content:replace', () => {
					// 延迟执行，确保URL已更新
					setTimeout(markActiveLink, 50);
				});
			} else {
				// 如果Swup还没准备好，稍后重试
				setTimeout(registerSwupHooks, 100);
			}
		}

		// 立即尝试注册钩子
		registerSwupHooks();
	}
</script>

<style>
	/* 链接的下划线动画 */
	.nav-link {
		position: relative;
	}

	.nav-link::after {
		content: '';
		position: absolute;
		bottom: 2px;
		left: 0;
		right: 0;
		height: 2px;
		background: var(--primary);
		opacity: 0;
		transition: opacity 0.3s ease;
	}

	.nav-link:hover::after {
		opacity: 0.5;
	}

	/* 当前页面的链接显示下划线 */
	.nav-link.active {
		color: var(--primary);
	}

	.nav-link.active::after {
		opacity: 1;
	}
</style>




