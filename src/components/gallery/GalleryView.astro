---
import ImageWrapper from "../misc/ImageWrapper.astro";
import GalleryMeta from "./GalleryMeta.astro";
import type { GalleryEntry } from "../../utils/gallery-utils";

interface Props {
	entries: GalleryEntry[];
}

const { entries } = Astro.props;

// é¢„æ¸²æŸ“æ‰€æœ‰æ–‡ç« å†…å®¹
const entryContents = new Map<string, any>();
for (const entry of entries) {
	const { Content } = await entry.render();
	entryContents.set(entry.id, Content);
}
---

<div class="featured-view flex flex-col gap-[100px] relative z-1 overflow-visible">
	{entries.length === 0 && (
		<div class="text-center py-12 text-slate-500 dark:text-slate-400">
			<p>æš‚æ— ç²¾é€‰å†…å®¹</p>
		</div>
	)}

	{entries.map((entry) => {
		const Content = entryContents.get(entry.id);
		const logo = entry.data.logo || null;
		return (
			<article class="gallery-card relative bg-white dark:bg-slate-800 rounded-xl overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-300 cursor-pointer" data-gallery-id={entry.id}>
				<div class="card-image-wrapper w-full relative z-1 transition-opacity duration-300 ease">
					<div class="card-image w-full relative z-1">
						<ImageWrapper
							src={entry.data.image}
							alt={entry.data.title}
							position="contain"
							enablePhotoswipe={false}
							fetchpriority="low"
						/>
						{logo && (
							<div class="logo-overlay">
								<img
									src={`${logo}`}
									alt="Logo"
									class="logo-image"
								/>
							</div>
						)}
					</div>
				</div>

				<div class="card-content-wrapper max-h-0 opacity-0 overflow-hidden transition-all duration-700 ease-[cubic-bezier(0.34,1.56,0.64,1)]">
					<div class="card-content relative w-full flex flex-col">
						<div class="content-image hidden">
							<ImageWrapper
								src={entry.data.image}
								alt={entry.data.title}
								position="contain"
								enablePhotoswipe={false}
								fetchpriority="high"
							/>
						</div>
						<div class="content-details flex-1 overflow-hidden flex flex-col min-h-0">
							<div class="details-header p-4 md:p-6 pb-4 border-b border-slate-200 dark:border-slate-700 flex-shrink-0">
								<h3 class="details-title text-xl md:text-2xl font-bold text-slate-800 dark:text-slate-100 mb-2">{entry.data.title}</h3>
								{entry.data.location && (
									<div class="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full text-sm mb-3">
										<span>ğŸ“ {entry.data.location}</span>
									</div>
								)}
								<GalleryMeta
									published={entry.data.published.toISOString()}
									updated={entry.data.updated?.toISOString()}
								/>
							</div>
							<div class="details-body flex-1 overflow-y-auto p-4 md:p-6 prose prose-slate dark:prose-invert max-w-none visible opacity-1">
								{Content && <Content />}
							</div>
						</div>
					</div>
				</div>
			</article>
		);
	})}
</div>

<script>
  console.log('GalleryView script started');

  // ä¸ºæ¯ä¸ªå¡ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç®€å•çš„å±•å¼€/æ”¶èµ·
  function initGalleryCards() {
    console.log('initGalleryCards called');
    document.querySelectorAll('.gallery-card').forEach(card => {
      // é¿å…é‡å¤æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      if (!card.hasAttribute('data-click-initialized')) {
        card.setAttribute('data-click-initialized', 'true');
        card.addEventListener('click', () => {
          // åˆ‡æ¢å±•å¼€çŠ¶æ€
          card.classList.toggle('expanded');

		  // ä¸ºç¡®ä¿åŠ¨ç”»æ­£ç¡®è§¦å‘ï¼Œå¼ºåˆ¶é‡æ’
		  (card as HTMLElement).offsetHeight;
        });
      }
    });
  }

  // Logo å¤§å°è°ƒæ•´é€»è¾‘
  function adjustLogoSize() {
    console.log('adjustLogoSize called');

    // è°ƒè¯•:æ‰“å°æ‰€æœ‰å¸¦logoçš„å¡ç‰‡
    const cardsWithLogo = document.querySelectorAll('[data-gallery-id]');
    console.log('Found cards:', cardsWithLogo.length);
    cardsWithLogo.forEach(card => {
      const id = card.getAttribute('data-gallery-id');
      const logoOverlay = card.querySelector('.logo-overlay');
      console.log(`Card ${id}: has logo =`, !!logoOverlay);
      if (logoOverlay) {
        const logoImg = logoOverlay.querySelector('.logo-image');
        console.log(`Logo image:`, logoImg, (logoImg as HTMLImageElement)?.src, (logoImg as HTMLImageElement)?.style);
      }
    });

    // ç›´æ¥æŸ¥æ‰¾æ‰€æœ‰ logo-overlay å…ƒç´ 
    const logoOverlays = document.querySelectorAll('.logo-overlay');
    console.log('Total logo overlays found:', logoOverlays.length);

    if (window.ResizeObserver) {
      const resizeObserver = new ResizeObserver(entries => {
        for (let entry of entries) {
          const imageContainer = entry.target;
          const containerHeight = entry.contentRect.height;

          // æŸ¥æ‰¾è¯¥å®¹å™¨å†…çš„logo-overlay
          const logoOverlay = imageContainer.querySelector('.logo-overlay');
          if (logoOverlay) {
            const logoImg = logoOverlay.querySelector('.logo-image');
            if (logoImg) {
              // è®¾ç½®Logoçš„æœ€å¤§é«˜åº¦ä¸ºå›¾ç‰‡é«˜åº¦çš„6%
              const maxHeight = containerHeight * 0.06;
              (logoImg as HTMLElement).style.maxHeight = maxHeight + 'px';

              // è®¾ç½®Logoä¸åº•éƒ¨çš„é—´è·ä¸ºå›¾ç‰‡é«˜åº¦çš„1%
              const bottomPadding = containerHeight * 0.01;
              (logoOverlay as HTMLElement).style.bottom = bottomPadding + 'px';
            }
          }
        }
      });

      // è§‚å¯Ÿæ‰€æœ‰card-imageå®¹å™¨
      document.querySelectorAll('.card-image').forEach(imageContainer => {
        resizeObserver.observe(imageContainer);
      });
    } else {
      // å¦‚æœä¸æ”¯æŒResizeObserverï¼Œåˆ™ä½¿ç”¨åŸå§‹æ–¹æ³•
      logoOverlays.forEach(overlay => {
        // è·å–çˆ¶çº§å›¾ç‰‡å®¹å™¨
        const imageContainer = overlay.closest('.card-image');
        if (imageContainer) {
          const imgElement = imageContainer.querySelector('img');
          if (imgElement && imgElement.offsetHeight > 0) {
            // è®¡ç®—å›¾ç‰‡é«˜åº¦çš„6%ä½œä¸ºLogoçš„æœ€å¤§é«˜åº¦
            const maxHeight = imgElement.offsetHeight * 0.06;
            // è®¾ç½®Logoçš„æœ€å¤§é«˜åº¦
            const logoImg = overlay.querySelector('.logo-image');
            if (logoImg) {
              (logoImg as HTMLElement).style.maxHeight = maxHeight + 'px';
            }

            // è®¡ç®—å›¾ç‰‡é«˜åº¦çš„1%ä½œä¸ºåº•éƒ¨é—´è·
            const bottomPadding = imgElement.offsetHeight * 0.01;
            (overlay as HTMLElement).style.bottom = bottomPadding + 'px';
          }
        }
      });
    }
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  function init() {
    console.log('init called, readyState:', document.readyState);
    initGalleryCards();
    // å»¶è¿Ÿæ‰§è¡Œ,ç¡®ä¿ DOM å®Œå…¨æ¸²æŸ“
    setTimeout(() => adjustLogoSize(), 100);
  }

  console.log('About to check readyState, readyState:', document.readyState);
  if (document.readyState === 'loading') {
    console.log('Adding DOMContentLoaded listener');
    document.addEventListener('DOMContentLoaded', init);
  } else {
    console.log('Calling init immediately');
    init();
  }

  // å›¾ç‰‡åŠ è½½åå†æ¬¡è°ƒæ•´Logoå¤§å°å’Œä½ç½®
  window.addEventListener('load', () => {
    console.log('window load event');
    setTimeout(() => adjustLogoSize(), 200);
  });
</script>

<style>
	.featured-view {
		@apply flex flex-col gap-[100px];
		position: relative;
		z-index: 1;
		overflow: visible !important;
	}

	.empty-state {
		@apply text-center py-12 text-slate-500 dark:text-slate-400;
	}

	.card-image-wrapper {
		@apply w-full;
		transition: opacity 0.3s ease;
		position: relative;
		z-index: 1;
	}

	.card-image {
		@apply w-full;
		position: relative;
		z-index: 1;
	}

	.card-image :global(img) {
		@apply w-full h-auto object-contain;
		display: block;
	}

	/* Logoè¦†ç›–å±‚ */
	.logo-overlay {
		position: absolute;
		bottom: 10px;
		left: 50%;
		transform: translateX(-50%);
		z-index: 10;
		border-radius: 8px;
		padding: 4px;
		width: auto;
		background: rgba(255, 255, 255, 0.8);
		backdrop-filter: blur(4px);
	}

	.logo-image {
		max-width: 80px;
		object-fit: contain;
		display: block;
		opacity: 0.9;
	}

	.content-image {
		@apply hidden;
	}

	/* å±•å¼€çŠ¶æ€ - æ˜¾ç¤ºå†…å®¹ */
	.gallery-card.expanded .card-content-wrapper {
		@apply max-h-[100vh] opacity-100 overflow-y-auto;
	}

	.details-body :global(.prose) {
		@apply max-w-none;
	}

	/* ç¡®ä¿å†…å®¹åŒºåŸŸçš„æ‰€æœ‰å…ƒç´ å¯è§ */
	.gallery-card.expanded .details-body :global(*) {
		visibility: visible !important;
		opacity: 1 !important;
	}
</style>